# Spring Security 정리

## 보안 시스템 빌드의 6가지 주요 원칙
1. - 무엇도 신뢰하지 않는다.
   - 들어오는 모든 요청을 검증한다.
2. - 최소 권한 할당 (각 사용자에게 필요한 사용자 역할과 엑세스 권한을 명확히 정해야 한다.)
3. - 완벽한 조율 구축 (요청일 들어올 때마다 엑세스 권한을 확인해야 한다.)
4. - 심측정인 방어 구축 (전송 레이어, 서버, 인프라에 보안을 구현해야 한다.)
5. - 메커니즘의 효율성 (보안 아키텍처를 가능한 간단하게 유지한다. 간단한 시스템을 보호하기가 더 쉽다.
6. - 설계의 개방성을 보장 

## 보안 시스템 빌드의 6가지 주요 원칙을 비행기 탑승의 예로 설명
1. 비행기 탑승은 여권이나 신분증이 없으면 탑승을 할 수 없다.
2. 공항을 이용하는 사람은 승무원, 조종사,탑승 수속 직원, 승객이 있다. 모든 사람이 할당된 이상으로 권한을 남용하지 않도록 각 레벨에서 보안 검사를 수행한다.
3. 공항의 입구는 명확하게 정해져 있고 이곳을 통해서만 공항에 들어올 수 있다. 모든 사람이 입구에서 인증(1)되고 권한(2)을 부여받는다. 자격을 확인받은 후에만 시스템, 즉 비행기에 들어올 수 있다.
4. 공항에서는 여권과 탑승권을 여러 번 검사한다. 보안 게이트 -> 보안 검색대 -> 탑승 전 티켓 확인 즉 다층적인 보안, 심층적인 보안을 구현한다.
5. 공항의 보안 절차는 간단해서 공항을 처음 이용하는 경우에도 모든 보안 절차를 쉽게 준수할 수 있다.
6. 일반적으로 전 세계 모든 공항에서 표준 보안 시스템이 적용되고 있다.

## Spring Security 작동 원리

### Spring MVC
Request -> Dispatcher Servlet -> Controller 순으로 작동한다.
1. 요청이 들어온다.
2. Dispatcher Servlet에서 모든 요청을 인터셉트해 url, 요청 메서드를 확인한 후 적절한 컨트롤러로 라우팅한다.

### Spring Security
Request -> Spring Security -> Dispatcher Servlet -> Controller
1. 요청이 들어온다.
2. 들어오는 모든 요청을 Spring Security Filter Chain이 인터셉트해서 인증과 권한 부여를 확인한다.
3. 요청이 Dispatcher Servlet으로 전송되고 그 다음 단계인 url, 요청 메서드를 확인한 후 적절한 컨트롤러로 라우팅한다.

## CORS

### CORS란?
브라우저에서는 보안적인 이유로 cross-origin HTTP 요청들을 제한한다. 그래서 cross-origin 요청을 하려면 서버의 동의가 필요하다. 
만약 서버가 동의한다면 브라우저에서는 요청을 허락하고, 동의하지 않는다면 브라우저에서 거절한다.

### cross-origin
cross-origin이란 다음 중 한 가지라도 다른 경우를 말한다.
1. 프로토콜 - http와 https는 프로토콜이 다르다.
2. 도메인 - domain.com과 other-domain.com은 다르다.
3. 포트 번호 - 8080포트와 3000포트는 다르다.

### CORS는 왜 필요한가?
CORS가 없이 모든 곳에서 데이터를 요청할 수 있게 되면, 다른 사이트에서 원래 사이트를 흉내낼 수 있게 된다.
예를 들어서 기존 사이트와 완전히 동일하게 동작하도록 하여 사용자가 로그인을 하도록 만들고, 
로그인했던 세션을 탈취하여 악의적으로 정보를 추출하거나 다른 사람의 정보를 입력하는 등 공격을 할 수 있다. 
이렇게 공격을 할 수 없도록 브라우저에서 보호하고, 필요한 경우 에만 서버와 협의하여 요청할 수 있도록 하기 위해서 필요하다.

### CORS는 어떻게 동작하나?
Simple requests인 경우
1. 서버로 요청을 한다.
2. 서버의 응답이 왔을 때 브라우저가 요청한 Origin과 응답한 헤더 Access-Control-Request-Headers의 값을 비교하여 유효한 요청이라면 리소스를 응답한다. 
만약 유효하지 않은 요청이라면 브라우저에서 이를 막고 에러가 발생한다.

#### Simple requests란?
HTTP method가 다음 중 하나이면서
- GET
- HEAD
- POST

자동으로 설정되는 헤더는 제외하고, 설정할 수 있는 다음 헤더들만 변경하면서
- Accept
- Accept-Language
- Content-Language

Content-Type이 다음과 같은 경우
- application/x-www-form-urlencoded
- multipart/form-data
- text/plain

## CSRF
CSRF 사이트 간 요청 위조
사용자가 웹 사이트에 로그인하면 사용자 세션이 생성된다.
이 사용자 세션은 브라우저의 쿠키를 사용해 식별되는데, 사용자가 웹사이트에서 로그아웃하지 않은 채 
악성 웹사이트로 이동하면, 악성 웹사이트에서는 사용자의 이전 인증 정보 브라우저에 있는 쿠키를 이용할 수 있다.
이러한 취약성을 CSRF, 사이트 간 요청 위조라고 한다.
<br/>
<br/>
Spring Security를 추가하면 GET이 아닌 POST, PUT요청에 CSRF 보호가 설정된다.

### Spring Security Logout 동작방식
1. 사용자가 로그아웃 요청
2. Spring Security가 로그아웃에 필요한 작업 수행
   - 세션 무효화
   - 인증토큰 삭제
   - 인증토큰을 갖고 있던 SecurityContext 또한 삭제
   - 쿠키정보 삭제
   - 로그인 페이지로 리다이렉트
